# Render Blueprint: Supabase (Postgres) + Render (FastAPI via Docker)
#
# How to use:
# - Push this repo to GitHub/GitLab
# - In Render: New -> Blueprint -> select repo
# - Set secrets (DATABASE_URL, SECRET_KEY, CORS_ORIGINS) in the Render UI
#
# Notes:
# - This blueprint keeps scheduler disabled by default. If you need it, enable it in ONE place only.
# - Migrations: this service runs Alembic on startup (with a Postgres advisory lock)
#   when RUN_MIGRATIONS_ON_START=true. This is safe for single-instance services and
#   avoids manual migration steps on Render.

services:
  - type: web
    name: hedge-control-alcast-backend
    runtime: docker
    plan: starter
    dockerfilePath: backend/Dockerfile
    dockerContext: backend
    autoDeployTrigger: commit
    healthCheckPath: /health
    envVars:
      - key: ENVIRONMENT
        value: production
      - key: ENABLE_DOCS
        value: "false"
      - key: DB_CONNECT_TIMEOUT_SECONDS
        value: "10"
      - key: DB_POOL_SIZE
        value: "5"
      - key: DB_MAX_OVERFLOW
        value: "5"
      - key: DB_POOL_TIMEOUT_SECONDS
        value: "10"
      - key: DB_STATEMENT_TIMEOUT_MS
        value: "5000"
      - key: WEB_CONCURRENCY
        value: "3"
      - key: UVICORN_TIMEOUT_KEEP_ALIVE
        value: "10"
      - key: CONCURRENCY_LIMITS_ENABLED
        value: "true"
      - key: CONCURRENCY_QUEUE_LOG_MS
        value: "50"
      - key: DASHBOARD_CONCURRENCY_LIMIT
        value: "4"
      - key: DASHBOARD_QUEUE_TIMEOUT_MS
        value: "1000"
      - key: EXPOSURES_CONCURRENCY_LIMIT
        value: "6"
      - key: EXPOSURES_QUEUE_TIMEOUT_MS
        value: "1000"
      - key: DASHBOARD_CIRCUIT_BREAKER_ENABLED
        value: "true"
      - key: DASHBOARD_CB_WINDOW
        value: "20"
      - key: DASHBOARD_CB_FAILURE_THRESHOLD
        value: "0.4"
      - key: DASHBOARD_CB_COOLDOWN_SECONDS
        value: "20"
      - key: SLOW_REQUEST_MS
        value: "2000"
      - key: SCHEDULER_ENABLED
        value: "false"
      - key: RUN_MIGRATIONS_ON_START
        value: "true"
      - key: CORS_ORIGINS
        value: '["https://hedge-control-alcast-frontend.vercel.app"]'
      # Secrets (set in Render UI):
      # - DATABASE_URL
      # - SECRET_KEY
      # - (optional override) CORS_ORIGINS
